#!/bin/bash

new_wt() {
    if [ -z "$1" ]; then
        echo "No branch provided"
        return
    fi

    cd ~/Workspace/web2
    TO_CHECKOUT="$1"
    BRANCH_NAME=""

    EXISTS=$(git show-ref refs/heads/"$TO_CHECKOUT")
    DIR_NAME="$(echo "$TO_CHECKOUT" | tr "/" "__")"

    if ! [ -z "$EXISTS" ]; then
        echo "Is upstream branch - checking out $TO_CHECKOUT in $DIR_NAME"

        git worktree add "$DIR_NAME" "$TO_CHECKOUT"
        cd "$DIR_NAME"
    else
        if [ "$DIR_NAME" = "atoda" ]; then
            BRANCH_NAME="$1"
            TO_CHECKOUT="$( cut -d '/' -f 2 <<< "$TO_CHECKOUT" )"
        else
            BRANCH_NAME="atoda/$TO_CHECKOUT"
        fi
        echo "Checking out new branch $BRANCH_NAME in $TO_CHECKOUT"

        git worktree add "$TO_CHECKOUT" -b "$BRANCH_NAME"
        cd "$TO_CHECKOUT"
    fi

    python3 -m venv .venv
    source .venv/bin/activate
    pip install --upgrade pip
    poetry install

    cp ~/Workspace/web2/common/ngrok ./ngrok
    cp ~/Workspace/web2/common/settings_local.py python/wolfproject/settings_local.py

    npm i
    export PATH=$(npm bin):$PATH

    python manage.py runserver
}

remove_wt() {
    if [ $(basename pwd) = "web2" ]; then
        echo "Already in project root"
        if [ -z "$2" ]; then
            echo "Need branch name to clean properly"
            return
        fi
    else
        cd ~/Workspace/web2
        BRANCH_NAME=$(git symbolic-ref --short HEAD)
    fi

    git worktree remove "$1"
    git branch -D "$BRANCH_NAME"
    git fetch --all
}
